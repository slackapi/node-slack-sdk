#!/bin/sh
set -e

cd "$(git rev-parse --show-toplevel)" || exit 1

pkgs=$(git diff --cached --name-only --diff-filter=ACMR -- 'packages/*/*' \
  | cut -d/ -f2 | sort -u)

[ -z "$pkgs" ] && exit 0

for pkg in $pkgs; do
  dir="packages/$pkg"
  [ -f "$dir/package.json" ] || continue

  echo "[pre-commit] $dir"

  out="$(npm --prefix "$dir" run -s lint:fix 2>&1)" && { git add -u "$dir"; continue; }

  echo "$out" | grep -qi 'missing script:.*lint:fix' && {
    out2="$(npm --prefix "$dir" run -s lint -- --fix 2>&1)" && { git add -u "$dir"; continue; }
    echo "$out2" | grep -qi 'missing script:.*lint' && { echo "[pre-commit] no lint script, skipping"; continue; }
    echo "$out2" >&2
    exit 1
  }

  echo "$out" >&2
  exit 1
done
