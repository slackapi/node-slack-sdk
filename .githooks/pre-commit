#!/bin/sh
set -e

cd "$(git rev-parse --show-toplevel)" || exit 1

pkgs=$(git diff --cached --name-only --diff-filter=ACMR -- 'packages/*/*' \
  | cut -d/ -f2 | sort -u)

[ -z "$pkgs" ] && exit 0

for pkg in $pkgs; do
  dir="packages/$pkg"
  [ -f "$dir/package.json" ] || continue

  echo "[pre-commit] $dir"

  tmp="$(mktemp)"
  if npm --prefix "$dir" run lint:fix 2>&1 | tee "$tmp"; then
    rm -f "$tmp"
    git add -u "$dir"
    continue
  fi

  if grep -qi 'missing script:.*lint:fix' "$tmp"; then
    rm -f "$tmp"
    npm --prefix "$dir" run lint -- --fix
    git add -u "$dir"
    continue
  fi

  rm -f "$tmp"
  exit 1
done